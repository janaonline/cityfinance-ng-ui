<div class="common-container">
  <form [formGroup]="reportForm" (ngSubmit)="search()">
    <div class="container-fluid">
      <div class="col-md-2">
        <div class="row">
          <!-- <div class="col-md-12" *ngIf="isFormInvalid">
            <i class="text-danger">All fields are mandatory</i>
            <br><br>
          </div> -->

          <div class="col-md-12 report-tabs">
            <a
              class="col-md-12"
              [ngClass]="{ active: activeGroup == 'IE' }"
              (click)="toggleTab('IE')"
              >Income & Expenditure</a
            >
            <a
              class="col-md-12"
              [ngClass]="{ active: activeGroup == 'BS' }"
              (click)="toggleTab('BS')"
              >Balance Sheet</a
            >
          </div>

          <div class="col-md-12">
            <br />
            <label for="" class="">Report Type </label>
          </div>
          <div class="col-md-12 form-group">
            <label class="radio-inline">
              <input
                type="radio"
                name="type"
                formControlName="type"
                value="Summary"
                checked
              />Summary
            </label>
            <label class="radio-inline">
              <input
                type="radio"
                name="type"
                formControlName="type"
                value="Detailed"
              />Detailed
            </label>
            <!-- <select formControlName="type" class="form-control" (change)="reportTypeChange()">
              <option>Summary</option>
              <option>Detailed</option>
              <option>Comparative Summary</option>
              <option>Comparative Detailed</option>
              <option>Comparative Summary ULB</option>
              <option>Comparative Detailed ULB</option>
              <option>Common Size Summary</option>
              <option>Common Size Detailed</option>
              <option>Common Size Summary ULB</option>
              <option>Common Size Detailed ULB</option>
            </select> -->
            <br />
          </div>

          <div class="col-md-12">
            <!-- <div class="checkbox">
              <label
                ><input
                  type="checkbox"
                  name="isComparative"
                  formControlName="isComparative"
                />
                Comparision Report
              </label>
            </div> -->
            <br />
          </div>

          <!-- <div class="col-md-12">
            <label for="" class="">Year <i class="text-danger">*</i></label>
          </div>
          <div class="col-md-12">
            <angular2-multiselect
              formControlName="yearList"
              [data]="yearLookup"
              [settings]="yearsDropdownSettings"
              (onClose)="onDateSelectionClose($event)"
            >
            </angular2-multiselect>
            <br />
          </div> -->

          <div class="col-md-12">
            <button
              type="button"
              for=""
              class="btn btn-warning btn-block"
              (click)="openUlbModal(UlbModal)"
            >
              Select State / ULB <i class="text-danger">*</i></button
            ><!--state-ulb-filter-->
            <b
              ><small
                class="text-danger pointer"
                (click)="clearFilter()"
                *ngIf="selectedUlbs?.length"
                >Clear filter</small
              ></b
            >
            <small class="right" *ngIf="selectedUlbs?.length"
              >{{ selectedUlbs.length }} ULBs selected</small
            >
            <br /><br />
          </div>

          <!-- <div class="col-md-12">
            <button
              class="btn btn-primary btn-block"
              (click)="search()"
            >
              Generate Report
            </button>
          </div> -->

          <div class="col-md-12">
            <br /><br />
            <a
              style="float: right; text-decoration: underline;"
              [routerLink]="['/dashboard/data-tracker']"
              >Download Source Files</a
            >
          </div>
        </div>
      </div>

      <div class="col-md-10">
        <router-outlet></router-outlet>
      </div>
    </div>
  </form>
</div>

<ng-template #UlbModal>
  <!-- <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div> -->

  <div class="modal-header" style="max-height: ;">
    <button
      type="button"
      class="close"
      data-dismiss="modal"
      aria-label="Close"
      style="display: block; outline: none;"
      (click)="modalRef.hide()"
    >
      <span aria-hidden="true">&Chi; </span>
    </button>
    <!-- <div
      class="col-xs-3 searchUlbMobalInput form-group mt-5"
      style="max-width: 20%;"
    >
      <input
        [formControl]="searchByNameControl"
        type="text"
        class="form-control"
        [(ngModel)]="ulbForm.ulbFilter"
        name="searchUlb"
        id="ulbSearch"
        placeholder="Search ULB"
        style="height: 34px;"
      />
    </div> -->

    <mat-form-field class="col-md-4" appearance="outline">
      <input
        type="text"
        placeholder="Search ULB"
        aria-label="text"
        matInput
        [formControl]="searchByNameControl"
        [matAutocomplete]="auto"
      />
      <mat-autocomplete #auto="matAutocomplete">
        <mat-option
          *ngFor="let option of ulbFilteredByName"
          [value]="option.name"
          (click)="
            setCurrentStateView({
              stateCode: option.stateCode,
              ulbType: option.type,
              ulb: option
            })
          "
          [title]="option.name.concat(' - ').concat(option.state)"
        >
          {{ option.name }} - {{ option.state }}
        </mat-option>
      </mat-autocomplete>
    </mat-form-field>

    <div class="col-md-3" style="max-width: 20%">
      <angular2-multiselect
        [data]="populationData"
        [settings]="populationDropdownSettings"
        [(ngModel)]="ulbForm.ulbPopulationFilter"
        (onSelect)="filterUlbs('ulbPopulationFilter')"
        (onDeSelect)="filterUlbs('ulbPopulationFilter')"
        (onDeSelectAll)="unselectAllPopulation($event)"
        class="right"
      >
      </angular2-multiselect>
    </div>

    <button
      type="button"
      class="close1  btn btn-primary"
      (click)="resetPopupValues()"
    >
      Clear All
    </button>

    <button
      class="btn btn-primary float-right"
      style="float: right; margin-right: 2%;"
      [disabled]="reportForm.invalid"
      (click)="search()"
    >
      Generate Report
      <span *ngIf="reportForm.controls['ulbList'].value.length">
        with {{ reportForm.controls["ulbList"].value.length }} ULBs
      </span>
    </button>

    <!-- <button
      type="button"
      class="close1 pull-right btn btn-primary"
      aria-label="Close"
      (click)="modalRef.hide()"
    >
      <span *ngIf="selectedUlbs?.length"
        >Proceed with {{ selectedUlbs?.length }} ULBs</span
      >
      <span *ngIf="!selectedUlbs?.length">Close</span>
    </button> -->
  </div>

  <form [formGroup]="reportForm" class="col-md-12 mt-1">
    <div
      class="checkbox"
      style="width: fit-content; display: inline-block; margin-right: 15px;"
    >
      <label
        ><input
          type="checkbox"
          name="isComparative"
          formControlName="isComparative"
        />
        Comparision Report
        <i
          class="fa fa-info-circle"
          aria-hidden="true"
          style="margin-left: 2px"
          title=" Placeholder"
        ></i>
      </label>
    </div>
    <angular2-multiselect
      style="display: inline-block;margin-top: 5px; "
      [style.width.px]="
        (reportForm?.controls)['yearList']?.value?.length
          ? reportForm.controls['yearList'].value.length * 55 + 161
          : 200
      "
      formControlName="yearList"
      [data]="yearLookup"
      [settings]="yearsDropdownSettings"
      (onClose)="onDateSelectionClose($event)"
      (onDeSelectAll)="reportForm.controls['yearList'].setValue([])"
    >
    </angular2-multiselect>
  </form>

  <div class="modal-body">
    <div class="row">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item">
          <a
            class="nav-link active inactive-tab"
            aria-controls="home"
            aria-selected="true"
          >
            States
          </a>
        </li>
        <li
          class="nav-item"
          *ngIf="reportForm.controls['isComparative']?.value"
        >
          <a
            class="nav-link"
            data-toggle="tab"
            role="tab"
            [ngClass]="{ ulbTypeSelected: ulbTypeSelected === 'base', 'inactive-tab': 
            reportForm.controls['isComparative'].value && !reportForm.controls['yearList'].value.length }"
            aria-controls="home"
            aria-selected="true"
            (click)="
              setULBType(
                'base',
                baseULBSelected ? true : false,
                reportForm.controls['isComparative'].value
              )
            "
            >Base ULB
            <i
              class="fa fa-info-circle"
              aria-hidden="true"
              style="margin-left: 5px"
              title="Base ULB for Comparison"
            ></i>
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link active"
            [ngClass]="{
              ulbTypeSelected: ulbTypeSelected === 'other',
              'inactive-tab':
                reportForm.controls['isComparative']?.value && !baseULBSelected
            }"
            data-toggle="tab"
            role="tab"
            aria-controls="profile"
            aria-selected="false"
            (click)="
              setULBType(
                'other',
                baseULBSelected ? true : false,
                reportForm.controls['isComparative'].value
              )
            "
            >ULBs
            <span *ngIf="reportForm.controls['isComparative']?.value"
              >for Comparison</span
            ></a
          >
        </li>
      </ul>

      <div class="col-md-2" style="max-height: 90vh; overflow: auto;">
        <ul class="list-unstyled left-nav">
          <li
            *ngFor="let state of ulbs.data | keyvalue"
            [ngClass]="{
              stateULBSelected: getTotalULBSelectedBy(state.key),
              activeState: currentStateInView?.key === state?.key
            }"
          >
            <a data-toggle="tab" class="active" (click)="showState(state)">
              <input
                #stateClear
                *ngIf="ulbTypeSelected === 'other'"
                _ngcontent-c4=""
                name="list_name_state"
                type="checkbox"
                value="false"
                class="ng-untouched ng-pristine ng-valid"
                [checked]="getTotalULBSelectedBy(state.key)"
                [disabled]="!getTotalULBSelectedBy(state?.key)"
                (click)="
                  removeAllSelectedULB(currentStateInView.key, null, stateClear)
                "
              />
              {{ state.value.state }}
              <span
                *ngIf="
                  getTotalULBSelectedBy(state.key) &&
                  ulbTypeSelected === 'other'
                "
              >
                ({{ getTotalULBSelectedBy(state.key) }})
              </span>
            </a>
          </li>
        </ul>
      </div>

      <div class="col-md-10">
        <ul class="list-group" *ngIf="currentStateInView">
          <li
            _ngcontent-c4=""
            class="list-group-item level-one col-md-12"
            id="Chhattisgarh"
            style="display: block;"
          >
            <div _ngcontent-c4="" class="row">
              <div _ngcontent-c4="" class="col-md-12">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                  <li
                    class="nav-item"
                    *ngFor="let ulb of ULBTYPES"
                    (click)="setULBTypeOfState(ulb)"
                  >
                    <a
                      class="nav-link active"
                      data-toggle="tab"
                      role="tab"
                      aria-controls="home"
                      aria-selected="true"
                      [ngClass]="{
                        ulbTabActive:
                          ulbTypeInView && ulbTypeInView.type === ulb.type,
                        stateULBSelected: getTotalULBSelectedBy(
                          currentStateInView.key,
                          {
                            type: ulb.type
                          }
                        )
                      }"
                    >
                      <input
                        #ulbType
                        *ngIf="ulbTypeSelected === 'other'"
                        _ngcontent-c4=""
                        name="list_name_state"
                        type="checkbox"
                        class="ng-untouched ng-pristine ng-valid"
                        [checked]="
                          getTotalULBSelectedBy(currentStateInView.key, {
                            type: ulb.type
                          })
                        "
                        [disabled]="
                          !getTotalULBSelectedBy(currentStateInView.key, {
                            type: ulb.type
                          })
                        "
                        (click)="
                          removeAllSelectedULB(
                            currentStateInView.key,
                            ulb.type,
                            ulbType
                          )
                        "
                      />
                      {{ ulb.type }}
                      <span
                        *ngIf="
                          ulbTypeSelected === 'other' &&
                          getTotalULBSelectedBy(currentStateInView.key, {
                            type: ulb.type
                          })
                        "
                      >
                        ({{
                          getTotalULBSelectedBy(currentStateInView.key, {
                            type: ulb.type
                          })
                        }})
                      </span>
                    </a>
                  </li>
                </ul>
                <ul class="nav nav-tabs" id="myTabContent" role="tablist">
                  <li
                    *ngFor="
                      let ulb of currentStateInView.value.ulbs
                        | keyvalue: valueAscOrder
                    "
                    class="list-group-item level-two checkbox col-md-4"
                    style="margin: 0px"
                    [id]="ulb['value']['code']"
                  >
                    <label _ngcontent-c4="">
                      <input
                        name="list_name_ulb"
                        *ngIf="ulbTypeSelected === 'other'"
                        type="checkbox"
                        [checked]="
                          StateULBTypeMapping[currentStateInView.key] &&
                          StateULBTypeMapping[currentStateInView.key][
                            ulbTypeInView.type
                          ] &&
                          StateULBTypeMapping[currentStateInView.key][
                            ulbTypeInView.type
                          ][ulb.value.code]
                            ? true
                            : false
                        "
                        value="ulb.value.code"
                        class="ng-untouched ng-pristine ng-valid"
                        (click)="
                          onULBClick(
                            currentStateInView.key,
                            ulbTypeInView,
                            ulb.value
                          )
                        "
                        [disabled]="
                          baseULBSelected &&
                          baseULBSelected.code === ulb.value.code
                        "
                      />

                      <input
                        name="list_name_ulb"
                        *ngIf="ulbTypeSelected === 'base'"
                        type="radio"
                        [value]="
                          baseULBSelected &&
                          baseULBSelected.code === ulb.value.code
                        "
                        class="ng-untouched ng-pristine ng-valid"
                        (click)="
                          selectedBaseULB(ulb.value, currentStateInView.key)
                        "
                      />
                      {{ ulb.value.name }}
                      <span
                        *ngIf="
                          baseULBSelected &&
                          baseULBSelected.code === ulb.value.code
                        "
                        >(selected as base)
                      </span>
                    </label>
                  </li>

                  <h2
                    *ngIf="!currentStateInView.value.ulbs.length"
                    style="text-align: center;"
                  >
                    ULB not available
                  </h2>
                </ul>
              </div>
            </div>
          </li>
        </ul>
      </div>
      <!-- <div class="col-md-12">
        <div class="col-md-6">
          <button
            type="button"
            class="close1 pull-right btn btn-primary"
            (click)="resetSelectedULB()"
          >
            <span>UnSelect All ULB</span>
          </button>
        </div>

        <div class="col-md-3">
          <angular2-multiselect
            [data]="ulbTypeLookup"
            [settings]="ulbTypeDropdownSettings"
            [(ngModel)]="ulbForm.ulbTypeFilter"
            (onSelect)="filterUlbs('ulbTypeFilter')"
            (onDeSelect)="filterUlbs('ulbTypeFilter')"
            (onDeSelectAll)="unselectAllULBTypes($event)"
            class="right"
          >
          </angular2-multiselect>
        </div>
      </div> -->

      <!-- <div class="col-md-12">
        <ul class="list-group level-one">
          <li
            class="list-group-item level-one col-md-12"
            *ngFor="let state of ulbs.data | keyvalue"
            [ngClass]="{
              hidden: state.value.ulbs && state.value.ulbs.length == 0
            }"
          >
            <input
              (click)="unselectStateULBS(state.value)"
              type="checkbox"
              [(ngModel)]="state.value.isSelected"
              name="list_name_state"
              value="{{ state.value.state }}"
              (ngModelChange)="selectStateCheckbox(state)"
              [disabled]="!state.value.isSelected"
            />
            <b>{{ state.value.state }} </b>

            <div class="row">
              <div class="col-md-12">
                <ul class="list-group level-two row">
                  <li
                    style="margin: 0px"
                    class="list-group-item level-two checkbox col-md-4"
                    *ngFor="let ulb of state.value.ulbs | keyvalue"
                    [ngClass]="{
                      hidden:
                        ulbForm.ulbFilter &&
                        ulb.value.name
                          .toLowerCase()
                          .indexOf(ulbForm.ulbFilter) == -1
                    }"
                  >
                    <label
                      ><input
                        type="checkbox"
                        [(ngModel)]="ulb.value.isSelected"
                        name="list_name_ulb"
                        value="{{ ulb.value.name }}"
                        (ngModelChange)="
                          selectUlbCheckbox(ulb, state, state.value.ulbs)
                        "
                      />
                      {{ ulb.value.name }}</label
                    >
                  </li>
                </ul>
              </div>
            </div>
          </li>
        </ul>
      </div> -->
    </div>
  </div>
</ng-template>
